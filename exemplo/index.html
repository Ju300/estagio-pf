<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Inteligeo - Mapa com Pontos de Interesse</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; font-family: Arial, sans-serif; }
        #map { height: 100%; width: 100%; }
        
        #addBtn {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 1000; padding: 15px 30px; font-size: 18px; font-weight: bold;
            border: none; border-radius: 8px; background-color: #2196F3; color: white;
            cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        #addBtn:hover { background-color: #1976D2; }
        #addBtn.active { background-color: #f44336; }
        
        .marker { background: red; border: 3px solid white; border-radius: 50%;
                  width: 25px; height: 25px; box-shadow: 0 3px 10px rgba(0,0,0,0.5); }
        
        #msg {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 10000; padding: 40px 60px; background: #4CAF50; color: white;
            border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            font-size: 28px; font-weight: bold; display: none; text-align: center;
        }
        
        #console {
            position: absolute; top: 80px; right: 10px; z-index: 1000;
            background: rgba(0,0,0,0.95); color: #0f0; padding: 20px;
            border-radius: 10px; max-width: 400px; max-height: 500px;
            overflow-y: auto; font-family: Courier; font-size: 13px;
        }
        #console h3 { color: #0f0; margin-bottom: 15px; border-bottom: 2px solid #0f0; padding-bottom: 8px; }
        .log { padding: 5px 0; line-height: 1.6; }
        .ok { color: #0f0; font-weight: bold; }
        .err { color: #f00; font-weight: bold; }
        .info { color: #0bf; }
        .warn { color: #ff0; }
        
        #lista {
            position: absolute; top: 80px; left: 10px; z-index: 1000;
            background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); max-width: 300px;
            max-height: 400px; overflow-y: auto;
        }
        #lista h3 { color: #2196F3; margin-bottom: 15px; font-size: 18px; }
        
        .item {
            padding: 12px; margin: 10px 0; background: #f5f5f5;
            border-radius: 8px; border-left: 5px solid #2196F3;
            cursor: pointer; transition: all 0.3s;
        }
        .item:hover { background: #e3f2fd; transform: translateX(8px); box-shadow: 0 3px 12px rgba(0,0,0,0.15); }
        .nome { font-weight: bold; color: #333; font-size: 15px; margin-bottom: 5px; }
        .desc { font-size: 13px; color: #666; }
        .vazio { color: #999; font-style: italic; text-align: center; padding: 30px; }
    </style>
</head>
<body>
    <button id="addBtn">ADICIONAR PONTO</button>
    <div id="msg"></div>
    
    <div id="console"><h3>DEBUG</h3><div id="logs"></div></div>
    <div id="lista"><h3>PONTOS: <span id="total">0</span></h3><div id="pontosDiv"><div class="vazio">Vazio</div></div></div>
    <div id="map"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        var NUM = 0;
        var logs = document.getElementById('logs');
        
        function LOG(t, c) {
            NUM++;
            c = c || 'info';
            var m = '[' + NUM + '] ' + new Date().toLocaleTimeString() + ' ' + t;
            console.log(m);
            var d = document.createElement('div');
            d.className = 'log ' + c;
            d.textContent = m;
            logs.appendChild(d);
            if (logs.children.length > 25) logs.removeChild(logs.firstChild);
            logs.scrollTop = logs.scrollHeight;
        }

        LOG('INICIO', 'ok');

        var ativo = false;
        var pontos = [];
        var id = 1;
        var marks = {};

        var btn = document.getElementById('addBtn');
        var msg = document.getElementById('msg');
        var pontosDiv = document.getElementById('pontosDiv');
        var total = document.getElementById('total');

        LOG('Criando mapa', 'info');
        var mapa = L.map('map').setView([-14.235, -51.9253], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(mapa);
        LOG('Mapa OK', 'ok');

        function mostrar(t) {
            LOG('MSG: ' + t, 'ok');
            msg.textContent = t;
            msg.style.display = 'block';
            setTimeout(function() { msg.style.display = 'none'; }, 2500);
        }

        function atualizar() {
            LOG('Atualizando lista', 'info');
            total.textContent = pontos.length;
            if (pontos.length === 0) {
                pontosDiv.innerHTML = '<div class="vazio">Vazio</div>';
                return;
            }
            pontosDiv.innerHTML = '';
            for (var i = 0; i < pontos.length; i++) {
                var p = pontos[i];
                var it = document.createElement('div');
                it.className = 'item';
                it.onclick = (function(pt) {
                    return function() {
                        LOG('Click: ' + pt.name, 'info');
                        mapa.setView([pt.lat, pt.lng], 15);
                        if (marks[pt.id]) marks[pt.id].openPopup();
                    };
                })(p);
                var n = document.createElement('div');
                n.className = 'nome';
                n.textContent = p.name;
                var de = document.createElement('div');
                de.className = 'desc';
                de.textContent = p.description || 'Sem descricao';
                it.appendChild(n);
                it.appendChild(de);
                pontosDiv.appendChild(it);
            }
            LOG('Lista OK', 'ok');
        }

        function criar(pt) {
            LOG('Criando marcador: ' + pt.name, 'info');
            var ic = L.divIcon({html: '<div class="marker"></div>', className: '', iconSize: [25,25], iconAnchor: [12,12], popupAnchor: [0,-12]});
            var m = L.marker([pt.lat, pt.lng], {icon: ic}).addTo(mapa);
            var h = '<div style="min-width:250px;padding:10px">' +
                '<h3 style="color:#2196F3;margin:0 0 15px 0;border-bottom:2px solid #2196F3;padding-bottom:8px">' + pt.name + '</h3>' +
                '<div style="margin:10px 0"><div style="font-weight:bold;color:#666;font-size:11px;text-transform:uppercase;margin-bottom:5px">DESCRICAO</div>' +
                '<div style="font-size:14px;color:#333">' + (pt.description || 'Sem descricao') + '</div></div>' +
                '<div style="margin-top:15px;padding-top:12px;border-top:1px solid #ddd;font-size:11px;color:#999">' +
                'Lat: ' + pt.lat.toFixed(6) + ' | Lng: ' + pt.lng.toFixed(6) + '</div></div>';
            m.bindPopup(h);
            marks[pt.id] = m;
            LOG('Marcador OK', 'ok');
            return m;
        }

        btn.onclick = function() {
            ativo = !ativo;
            btn.textContent = ativo ? 'CANCELAR' : 'ADICIONAR PONTO';
            btn.classList.toggle('active', ativo);
            mapa.getContainer().style.cursor = ativo ? 'crosshair' : '';
            LOG('Modo: ' + (ativo ? 'ATIVO' : 'OFF'), ativo ? 'ok' : 'info');
        };

        mapa.on('click', function(e) {
            LOG('Click mapa', 'info');
            if (!ativo) { LOG('OFF - ignorado', 'warn'); return; }
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;
            LOG('Pos: ' + lat.toFixed(4) + ',' + lng.toFixed(4), 'info');
            
            var h = '<div style="padding:15px">' +
                '<div style="margin-bottom:15px"><label style="display:block;margin-bottom:8px;font-weight:bold;font-size:15px">Nome *</label>' +
                '<input type="text" id="ni" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:15px" placeholder="Ex: Sede PF"></div>' +
                '<div style="margin-bottom:15px"><label style="display:block;margin-bottom:8px;font-weight:bold;font-size:15px">Descricao</label>' +
                '<textarea id="di" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:15px;min-height:70px;resize:vertical" placeholder="Ex: DITEC"></textarea></div>' +
                '<div style="display:flex;gap:12px">' +
                '<button id="sb" style="flex:1;padding:12px;font-size:16px;font-weight:bold;border:none;border-radius:6px;background:#4CAF50;color:white;cursor:pointer">SALVAR</button>' +
                '<button id="cb" style="flex:1;padding:12px;font-size:16px;font-weight:bold;border:none;border-radius:6px;background:#f44336;color:white;cursor:pointer">CANCELAR</button>' +
                '</div></div>';
            
            LOG('Popup criando', 'info');
            var popup = L.popup({closeOnClick: false, autoClose: false, maxWidth: 350}).setLatLng([lat, lng]).setContent(h).openOn(mapa);
            LOG('Popup OK', 'ok');
            
            setTimeout(function() {
                LOG('Config eventos', 'info');
                var sb = document.getElementById('sb');
                var cb = document.getElementById('cb');
                var ni = document.getElementById('ni');
                var di = document.getElementById('di');
                
                if (!sb || !ni) { LOG('ERRO: elementos nao encontrados', 'err'); return; }
                LOG('Elementos OK', 'ok');
                
                sb.onclick = function() {
                    LOG('>>> SALVAR <<<', 'ok');
                    var n = ni.value.trim();
                    var d = di.value.trim();
                    LOG('Nome: "' + n + '"', 'info');
                    LOG('Desc: "' + d + '"', 'info');
                    
                    if (!n) {
                        LOG('Nome vazio', 'err');
                        alert('Digite o nome!');
                        ni.focus();
                        return;
                    }
                    
                    var np = {id: id++, lat: lat, lng: lng, name: n, description: d, createdAt: new Date().toISOString()};
                    LOG('Ponto ID: ' + np.id, 'ok');
                    pontos.push(np);
                    LOG('Total: ' + pontos.length, 'ok');
                    criar(np);
                    atualizar();
                    mapa.closePopup();
                    ativo = false;
                    btn.textContent = 'ADICIONAR PONTO';
                    btn.classList.remove('active');
                    mapa.getContainer().style.cursor = '';
                    mostrar('PONTO "' + n + '" SALVO');
                    LOG('=== SUCESSO ===', 'ok');
                };
                
                cb.onclick = function() {
                    LOG('Cancelado', 'info');
                    mapa.closePopup();
                    ativo = false;
                    btn.textContent = 'ADICIONAR PONTO';
                    btn.classList.remove('active');
                    mapa.getContainer().style.cursor = '';
                };
                
                LOG('Eventos OK', 'ok');
                ni.focus();
            }, 250);
        });

        atualizar();
        LOG('=== PRONTO ===', 'ok');
    </script>
</body>
</html>